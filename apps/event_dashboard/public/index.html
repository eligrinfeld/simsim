<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Event-Aware Trading Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system; background: #0b0e11; color: #e6e6e6; }
    header { padding: 12px 16px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #20252b; }
    .badge { padding: 2px 8px; border-radius: 999px; background: #1f2937; font-size: 12px; }
    #chart { height: 560px; }
    .legend { display:flex; gap:12px; font-size: 12px; padding: 8px 16px; color: #a7b0bd;}
    .legend span { display:inline-flex; align-items:center; gap:6px;}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dot.green{background:#22c55e}.dot.red{background:#ef4444}.dot.blue{background:#60a5fa}.dot.yellow{background:#eab308}
    .panel { display:flex; gap:16px; padding: 8px 16px; font-size: 12px; color:#a7b0bd; }
    .panel .kv { background:#0e1318;border:1px solid #20252b;border-radius:10px;padding:6px 10px;}
    .filters { display:flex; gap:8px; padding: 6px 16px; flex-wrap: wrap; }
    .chip { border:1px solid #243040; background:#0e1318; color:#d1d5db; padding:4px 10px; border-radius:999px; font-size:11px; cursor:pointer; }
    .chip.active { background:#1f2937; border-color:#2b3645; }
    .subpanes { padding: 6px 16px; display:flex; flex-direction:column; gap:8px; }
    .pane { height: 120px; border-top:1px solid #20252b; }
    .tracks { display:flex; flex-direction:column; gap:6px; padding: 6px 16px 12px; }
    .track { display:flex; align-items:center; gap:10px; }
    .track h4 { margin:0; font-size:12px; color:#9aa4b2; width:110px; display:flex; align-items:center; gap:8px; }
    .lane { display:flex; flex-wrap:wrap; gap:6px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:11px; cursor:pointer; border:1px solid #243040; background:#0e1318; color:#d1d5db; }
    .pill .dot { width:6px; height:6px; border-radius:999px; display:inline-block; }
    .drawer { position:fixed; top:0; right:0; width:360px; max-width:80vw; height:100vh; background:#0e1318; border-left:1px solid #20252b; transform: translateX(100%); transition: transform .2s ease; box-shadow: -8px 0 20px rgba(0,0,0,.3); z-index: 9999; }
    .drawer.open { transform: translateX(0); }
    .drawer .hd { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid #20252b; }
    .drawer .bd { padding:12px 14px; font-size:13px; color:#c6ced8; }
    .drawer .bd h5 { margin:10px 0 6px; font-size:12px; color:#9aa4b2; }
    .drawer .bd .kv { display:flex; justify-content:space-between; }
    .btn { background:#1f2937; border:1px solid #2b3645; color:#e5e7eb; padding:4px 8px; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <strong>SPY — Event Overlay</strong>
    <span class="badge">lightweight-charts</span>
    <span class="badge">Live demo</span>
  </header>
  <div class="filters">
    <span class="chip active" data-filter="macro">Macro</span>
    <span class="chip active" data-filter="news">News</span>
    <span class="chip active" data-filter="signals">Signals</span>
    <span class="chip" id="clearPills">Clear</span>
    <span class="chip" data-indic="vol">Vol</span>
    <span class="chip" data-indic="rsi">RSI</span>
    <span class="chip" data-indic="macd">MACD</span>
    <span class="chip" id="importPine">Import Pine</span>
  </div>
  <div id="chart"></div>
  <div class="legend">
    <span><i class="dot blue"></i> Bar</span>
    <span><i class="dot green"></i> Breakout / NewsBurst</span>
    <span><i class="dot yellow"></i> MacroShock</span>
    <span><i class="dot red"></i> TradeEntryIntent</span>
  </div>
  <div class="panel" id="status">
    <div class="kv">WS: <b id="wsState">connecting…</b></div>
    <div class="kv">Last event: <b id="lastEvt">—</b></div>
    <div class="kv">RSI: <b id="rsiVal">—</b></div>
    <div class="kv">MACD: <b id="macdVal">—</b></div>
  </div>

  <div class="tracks">
    <div class="track" id="macroTrack">
      <h4>Macro</h4>
      <div class="lane" id="macroLane"></div>
    </div>
    <div class="track" id="newsTrack">
      <h4>News</h4>
      <div class="lane" id="newsLane"></div>
  <dialog id="pineDlg">
    <form method="dialog" style="background:#0e1318;color:#e5e7eb;border:1px solid #20252b;border-radius:8px;max-width:780px;width:90vw">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid #20252b">
        <strong>Import Pine (MVP subset)</strong>
        <button class="btn" value="close">Close</button>
      </div>
      <div style="padding:10px 12px;display:flex;flex-direction:column;gap:8px">
        <small>Supported: input.int/float, ta.sma/ema/rsi, ta.crossover/crossunder, strategy.entry/close</small>
        <textarea id="pineCode" style="width:100%;height:200px;background:#0b0e11;color:#e5e7eb;border:1px solid #243040;border-radius:6px;padding:8px" placeholder="Paste Pine strategy..."></textarea>
        <div style="display:flex;gap:8px">
          <button type="button" class="btn" id="pinePreview">Preview</button>
          <span id="pineStatus" style="font-size:12px;color:#9aa4b2"></span>
        </div>
      </div>
    </form>
  </dialog>

    </div>
    <div class="track" id="signalsTrack">
      <h4>Signals</h4>
      <div class="lane" id="signalsLane"></div>
    </div>
  </div>

  <section id="pineSection" style="padding:16px">
    <div style="display:flex;flex-direction:column;gap:8px;max-width:980px;margin:0 auto">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Import Pine (MVP subset)</strong>
        <button class="btn" id="pineRun">Preview</button>
      </div>
      <small>Supported: input.int/float, ta.sma/ema/rsi, ta.crossover/crossunder, strategy.entry/close, bbands, macd, stoch, supertrend, thresholds</small>
      <textarea id="pineCodeArea" style="width:100%;height:180px;background:#0b0e11;color:#e5e7eb;border:1px solid #243040;border-radius:6px;padding:8px" placeholder="Paste Pine strategy..."></textarea>
      <div id="pineResult" style="font-size:12px;color:#9aa4b2"></div>
    </div>
  </section>

  <div class="drawer" id="drawer">
    <div class="hd"><strong id="drawerTitle">Event</strong><button class="btn" id="drawerClose">Close</button></div>
    <div class="bd" id="drawerBody"></div>
  </div>

  <script>
    const container = document.getElementById('chart');
    const chart = LightweightCharts.createChart(container, {
      layout: { background: { color: '#0b0e11' }, textColor: '#e6e6e6' },
      grid: { vertLines: { color: '#1a1f25' }, horzLines: { color: '#1a1f25' } },
      timeScale: { timeVisible: true, secondsVisible: true, borderColor: '#20252b' },
      rightPriceScale: { borderColor: '#20252b' },
      leftPriceScale: { visible: true, borderColor: '#20252b' },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    });
    const candleSeries = chart.addCandlestickSeries({
      upColor: '#22c55e', downColor: '#ef4444', borderDownColor: '#ef4444', borderUpColor: '#22c55e', wickDownColor: '#ef4444', wickUpColor: '#22c55e'
    });
    const volSeries = chart.addHistogramSeries({ color: 'rgba(100, 181, 246, 0.4)', priceFormat: { type: 'volume' }, priceScaleId: 'left' });
    // Use secondary overlay scale for indicators to avoid distorting price
    const overlayScale = 'overlay';
    const rsiSeries = chart.addLineSeries({ color: '#f97316', lineWidth: 1, priceScaleId: overlayScale });
    // RSI guide bands
    const rsi30Series = chart.addLineSeries({ color: 'rgba(255,255,255,0.15)', lineWidth: 1, priceScaleId: overlayScale });
    const rsi70Series = chart.addLineSeries({ color: 'rgba(255,255,255,0.15)', lineWidth: 1, priceScaleId: overlayScale });
    const macdSeries = chart.addLineSeries({ color: '#a78bfa', lineWidth: 1, priceScaleId: overlayScale });
    const macdSignalSeries = chart.addLineSeries({ color: '#60a5fa', lineWidth: 1, priceScaleId: overlayScale });
    const macdHistSeries = chart.addHistogramSeries({ priceScaleId: overlayScale });

    const markers = [];

    function ema(values, period){
      const k = 2 / (period + 1);
      let prev;
      return values.map((v,i) => {
        if (i===0){ prev = v; return v; }
        prev = v * k + prev * (1-k);
        return prev;
      });
    }
    function rsi(closes, period=14){
      const gains = []; const losses = [];
      for (let i=1;i<closes.length;i++){
        const ch = closes[i]-closes[i-1];
        gains.push(Math.max(0,ch)); losses.push(Math.max(0,-ch));
      }
      let avgGain = gains.slice(0, period).reduce((a,b)=>a+b,0)/period;
      let avgLoss = losses.slice(0, period).reduce((a,b)=>a+b,0)/period;
      const out = new Array(closes.length).fill(null);
      out[period] = 100 - (100/(1 + (avgGain/(avgLoss||1e-9))));
      for (let i=period+1;i<closes.length;i++){
        avgGain = (avgGain*(period-1) + gains[i-1]) / period;
        avgLoss = (avgLoss*(period-1) + losses[i-1]) / period;
        out[i] = 100 - (100/(1 + (avgGain/(avgLoss||1e-9))));
      }
      return out;
    }
    function macd(closes, fast=12, slow=26, signal=9){
      const emaFast = ema(closes, fast);
      const emaSlow = ema(closes, slow);
      const macdLine = emaFast.map((v,i)=> v - (emaSlow[i]||v));
      const signalLine = ema(macdLine.map(v=>v||0), signal);
      const hist = macdLine.map((v,i)=> (v||0) - (signalLine[i]||0));
      return { macdLine, signalLine, hist };
    }

    fetch('/candles').then(r => r.json()).then(rows => {
      candleSeries.setData(rows.map(k => ({ time: k.time, open: k.open, high: k.high, low: k.low, close: k.close })));
      const closes = rows.map(k=>k.close);
      const times = rows.map(k=>k.time);
      // indicators
      volSeries.setData(rows.map(k=>({ time:k.time, value:k.volume })));
      const rsiVals = rsi(closes,14);
      const rsiData = rsiVals.map((v,i)=> v==null?null:{ time: times[i], value: v }).filter(Boolean);
      rsiSeries.setData(rsiData);
      // RSI guide bands
      rsi30Series.setData(times.map(t=>({ time:t, value:30 })));
      rsi70Series.setData(times.map(t=>({ time:t, value:70 })));
      const m = macd(closes);
      const macdData = m.macdLine.map((v,i)=>({ time: times[i], value: v||0 }));
      const macdSigData = m.signalLine.map((v,i)=>({ time: times[i], value: v||0 }));
      const macdHistData = m.hist.map((v,i)=>({ time: times[i], value: Math.abs(v||0), color: (v||0) >= 0 ? 'rgba(34,197,94,0.4)' : 'rgba(239,68,68,0.4)' }));
      macdSeries.setData(macdData);
      macdSignalSeries.setData(macdSigData);
      macdHistSeries.setData(macdHistData);
      window._indicCache = { closes, times, rsiVals, rsiData, macd: m, macdData, macdSigData, macdHistData };
      macdSignalSeries.setData(m.signalLine.map((v,i)=>({ time: times[i], value: v||0 })));
      macdHistSeries.setData(m.hist.map((v,i)=>({ time: times[i], value: Math.abs(v||0), color: (v||0) >= 0 ? 'rgba(34,197,94,0.4)' : 'rgba(239,68,68,0.4)' })));
    });

    function addMarker(time, position, color, shape, text, id) {
      markers.push({ time, position, color, shape, text, id });
      candleSeries.setMarkers(markers);
    }

    const wsState = document.getElementById('wsState');
    const lastEvt = document.getElementById('lastEvt');

    // Tracks & Drawer state
    const macroLane = document.getElementById('macroLane');
    const newsLane = document.getElementById('newsLane');
    const signalsLane = document.getElementById('signalsLane');
    const drawer = document.getElementById('drawer');
    const drawerTitle = document.getElementById('drawerTitle');
    const drawerBody = document.getElementById('drawerBody');
    const drawerClose = document.getElementById('drawerClose');
    drawerClose.onclick = () => drawer.classList.remove('open');

    // Reconnect/backfill state
    let lastSeenTs = Number(sessionStorage.getItem('evt:lastTs') || 0);
    function rememberTs(ts){ if (ts>0){ lastSeenTs = Math.max(lastSeenTs, ts); sessionStorage.setItem('evt:lastTs', String(lastSeenTs)); } }
    function replay(events){
      for (const evt of events){
        evt.ts && handleEvent(evt);
        rememberTs(evt.ts||0);
      }
    }

	    async function fetchBackfill(){
	      try{
	        const res = await fetch('/events' + (lastSeenTs ? (`?since=${lastSeenTs}`) : ''));
	        if (res.ok){ const rows = await res.json(); replay(rows); }
	      }catch(e){}
	    }


    function handleEvent(evt){
      lastEvt.textContent = `${evt.type} @ ${new Date(evt.ts * 1000).toLocaleTimeString()}`;
      rememberTs(evt.ts||0);
      if (evt.type === 'Bar') {
        const k = evt.data;
        candleSeries.update({ time: k.time, open: k.open, high: k.high, low: k.low, close: k.close });
        // Incremental indicator updates
        if (window._indicCache){
          const c = window._indicCache;
          c.closes.push(k.close); c.times.push(k.time);
          const closes = c.closes; const times = c.times;
          const rsiVals = rsi(closes,14);
          const last = rsiVals[rsiVals.length-1];
          if (last != null) rsiSeries.update({ time: times[times.length-1], value: last });
          rsi30Series.update({ time: times[times.length-1], value: 30 });
          rsi70Series.update({ time: times[times.length-1], value: 70 });
          const m = macd(closes);
          const t = times[times.length-1];
          macdSeries.update({ time: t, value: m.macdLine[m.macdLine.length-1]||0 });
          macdSignalSeries.update({ time: t, value: m.signalLine[m.signalLine.length-1]||0 });
          const hv = m.hist[m.hist.length-1]||0;
          macdHistSeries.update({ time: t, value: Math.abs(hv), color: hv >= 0 ? 'rgba(34,197,94,0.4)' : 'rgba(239,68,68,0.4)' });
          c.rsiVals = rsiVals; c.macd = m;
          // Legend labels
          document.getElementById('rsiVal').textContent = (last!=null? last.toFixed(1): '—');
          document.getElementById('macdVal').textContent = `${(m.macdLine.at(-1)||0).toFixed(2)} / ${(m.signalLine.at(-1)||0).toFixed(2)}`;
        }
        return;
      }
      if (evt.type === 'Breakout') {
        addMarker(evt.ts, 'aboveBar', '#22c55e', 'arrowUp', 'Breakout', evt.data?.price);
        const node = pill('#22c55e', 'Breakout', evt, '↗'); node.title = 'Technical breakout'; signalsLane.appendChild(node); trimLane(signalsLane);
      }
      if (evt.type === 'NewsBurst') {
        addMarker(evt.ts, 'aboveBar', '#22c55e', 'circle', 'NewsBurst (≥3 pos in 2m)', 'news'+evt.ts);
        const node = pill('#22c55e', 'NewsBurst', evt, '●'); node.title = 'News burst'; newsLane.appendChild(node); trimLane(newsLane);
      }
      if (evt.type === 'MacroShock') {
        addMarker(evt.ts, 'belowBar', '#eab308', 'square', `MacroShock (CPI ${evt.data.surprise.toFixed(2)})`, 'macro'+evt.ts);
        const node = pill('#eab308', `MacroShock ${evt.data.surprise.toFixed(2)}`, evt, '■'); node.title = 'Macro surprise'; macroLane.appendChild(node); trimLane(macroLane);
      }
      if (evt.type === 'TradeEntryIntent') {
        addMarker(evt.ts, 'belowBar', '#ef4444', 'arrowUp', 'TradeEntryIntent (macro→breakout)', 'entry'+evt.ts);
        const node = pill('#ef4444', 'TradeEntryIntent', evt, '★'); node.title = 'Sequence match'; signalsLane.appendChild(node); trimLane(signalsLane);
      }
    }


    const filters = { macro: true, news: true, signals: true };
    document.querySelectorAll('.chip[data-filter]').forEach(ch => {
      ch.addEventListener('click', () => {
        const k = ch.getAttribute('data-filter');
        filters[k] = !filters[k];
        ch.classList.toggle('active', filters[k]);
        document.getElementById(k + 'Track').style.display = filters[k] ? 'flex' : 'none';
        saveFilters();
        // Telemetry
        fetch('/telemetry', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({cat:'filters', action:k, enabled:filters[k]})}).catch(()=>{});
      });
    });

    const MAX_PILLS = 50;
    function trimLane(lane){
      while (lane.children.length > MAX_PILLS) lane.removeChild(lane.firstChild);
    }

    // Telemetry throttling (max ~4 req/sec)
    const _tele_q = [];
    let _tele_t = null;
    function teleEnqueue(payload){ _tele_q.push(payload); _teleSchedule(); }
    function _teleSchedule(){ if (_tele_t) return; _tele_t = setTimeout(_teleFlush, 250); }
    function _teleFlush(){
      const p = _tele_q.shift();
      if (p){ fetch('/telemetry', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(p)}).catch(()=>{}); }
      if (_tele_q.length){ _tele_t = setTimeout(_teleFlush, 250); } else { _tele_t = null; }
    }

    function drawerContent(evt){
      const ts = new Date(evt.ts * 1000).toLocaleString();
      let why = '';
      let evidence = '';
      if (evt.type === 'Breakout') {
        const price = evt.data.price ?? evt.data.close;
        const lb = evt.data.lookback ?? 20;
        why = `Close > ${lb}-bar high`;
        evidence = `<div class=\"kv\"><span>Price</span><span>${price?.toFixed ? price.toFixed(2) : price}</span></div>`+
                   `<div class=\"kv\"><span>Lookback</span><span>${lb}</span></div>`;
      } else if (evt.type === 'NewsBurst') {
        const count = evt.data.count ?? 3;
        const windowSec = evt.data.window_sec ?? 120;
        why = `≥${count} positive news in ${Math.round(windowSec/60)}m`;
        evidence = `<div class=\"kv\"><span>Count</span><span>${count}</span></div>`+
                   `<div class=\"kv\"><span>Window</span><span>${windowSec}s</span></div>`;
      } else if (evt.type === 'MacroShock') {
        const a = evt.data.actual ?? 0;
        const e = evt.data.estimate ?? 0;
        const s = evt.data.surprise;
        why = `|surprise| ≥ 0.3 (CPI)`;
        evidence = `<div class=\"kv\"><span>Actual</span><span>${a.toFixed ? a.toFixed(2) : a}</span></div>`+
                   `<div class=\"kv\"><span>Estimate</span><span>${e.toFixed ? e.toFixed(2) : e}</span></div>`+
                   `<div class=\"kv\"><span>Surprise</span><span>${s.toFixed ? s.toFixed(2) : s}</span></div>`;
      } else if (evt.type === 'TradeEntryIntent') {
        why = `MacroShock then Breakout within 15m`;
        evidence = `<div class=\"kv\"><span>Rule</span><span>${evt.data.rule||'macro_then_breakout'}</span></div>`;
      }
      return `
        <div class=\"kv\"><span><b>Type</b></span><span>${evt.type}</span></div>
        <div class=\"kv\"><span><b>Time</b></span><span>${ts}</span></div>
        <h5>Why it fired</h5>
        <div>${why || '—'}</div>
        <h5>Evidence</h5>
        ${evidence || '<div>—</div>'}
      `;
    }

    function pill(color, label, evt, icon){
      const el = document.createElement('span');
      el.className = 'pill';
      const dot = document.createElement('i'); dot.className = 'dot'; dot.style.background = color;
      const ic = document.createElement('span'); ic.textContent = icon || '';
      el.appendChild(dot); el.appendChild(ic); el.appendChild(document.createTextNode(label));
      el.onclick = () => {
        drawerTitle.textContent = label;
        drawerBody.innerHTML = drawerContent(evt);
        drawer.classList.add('open');
        teleEnqueue({cat:'pill', action:evt.type, ts:evt.ts});
      };
      return el;
    }

    document.getElementById('clearPills').onclick = () => {
      [macroLane, newsLane, signalsLane].forEach(l => l.innerHTML='');
    };

    function saveFilters(){ try{ localStorage.setItem('evt:filters', JSON.stringify(filters)); }catch(e){} }
    function loadFilters(){ try{ return JSON.parse(localStorage.getItem('evt:filters')) || filters; }catch(e){ return filters; } }

    // Init filters from storage
    const stored = loadFilters();
    Object.keys(filters).forEach(k => {
      filters[k] = !!stored[k];
      const chip = document.querySelector(`.chip[data-filter="${k}"]`);
      if (chip) chip.classList.toggle('active', filters[k]);
      document.getElementById(k + 'Track').style.display = filters[k] ? 'flex' : 'none';
    });

    // Indicator toggles + persistence
    const indicState = JSON.parse(localStorage.getItem('evt:indic') || '{"vol":false,"rsi":false,"macd":false}');
    function persistIndic(){ try{ localStorage.setItem('evt:indic', JSON.stringify(indicState)); }catch(e){} }
    function syncIndic(){
      document.querySelectorAll('.chip[data-indic]').forEach(ch => {
        const k = ch.getAttribute('data-indic');
        ch.classList.toggle('active', !!indicState[k]);
      });
      volSeries.applyOptions({ visible: !!indicState.vol });
      rsiSeries.applyOptions({ visible: !!indicState.rsi });
      rsi30Series.applyOptions({ visible: !!indicState.rsi });
      rsi70Series.applyOptions({ visible: !!indicState.rsi });
      macdSeries.applyOptions({ visible: !!indicState.macd });
      macdSignalSeries.applyOptions({ visible: !!indicState.macd });
      macdHistSeries.applyOptions({ visible: !!indicState.macd });
    }
    syncIndic();

    document.querySelectorAll('.chip[data-indic]').forEach(ch => {
      ch.addEventListener('click', () => {
        const k = ch.getAttribute('data-indic');
        indicState[k] = !indicState[k];
        persistIndic();
        syncIndic();
      });
    });

    function connectWS(){
      let attempts = 0; let ws;
      function open(){
        ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws');
        ws.onopen = () => { wsState.textContent = 'connected'; attempts = 0; fetchBackfill(); };
        ws.onclose = () => { wsState.textContent = 'disconnected'; schedule(); };
        ws.onerror = () => { wsState.textContent = 'error'; ws.close(); };
        ws.onmessage = (m) => { try{ handleEvent(JSON.parse(m.data)); }catch(e){} };
      }
      function schedule(){
        attempts += 1;
        const backoff = Math.min(5000, 500 * Math.pow(2, Math.min(attempts, 4)));

        setTimeout(open, backoff);
      }
      open();
    }

    // Pine dialog handlers
    const pineDlg = document.getElementById('pineDlg');
    document.getElementById('importPine').onclick = () => pineDlg.showModal();
    // Pine section handler
    const pineArea = document.getElementById('pineCodeArea');
    const pineRunBtn = document.getElementById('pineRun');
    const pineResult = document.getElementById('pineResult');
    pineRunBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const code = pineArea.value;
      pineResult.textContent = 'Running...';
      try{
        const res = await fetch('/strategy/pine/preview', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({code})});
        if (!res.ok){ pineResult.textContent = 'Error: '+res.status; return; }
        const js = await res.json();
        pineResult.textContent = `${js.result.name} | Sharpe ${js.result.sharpe.toFixed(2)} | Return ${(js.result.total_return*100).toFixed(1)}%`;
        js.result.trades.forEach(t => {
          addMarker(t.ts, t.side==='buy'?'belowBar':'aboveBar', t.side==='buy'?'#22c55e':'#ef4444', t.side==='buy'?'arrowUp':'arrowDown', (t.side==='buy'?'Buy':'Sell')+` @ ${t.price.toFixed(2)}`, `${t.side}${t.ts}`);
        });
        drawerTitle.textContent = js.result.name;
        drawerBody.innerHTML = `<h5>Performance</h5><div class='kv'><span>Sharpe</span><span>${js.result.sharpe.toFixed(2)}</span></div><div class='kv'><span>Total Return</span><span>${(js.result.total_return*100).toFixed(1)}%</span></div><div class='kv'><span>Max DD</span><span>${(js.result.max_drawdown*100).toFixed(1)}%</span></div>`;
        drawer.classList.add('open');
      }catch(err){ pineResult.textContent = 'Error'; }
    });

    document.getElementById('pinePreview').onclick = async () => {
      const code = document.getElementById('pineCode').value;
      const st = document.getElementById('pineStatus');
      st.textContent = 'Running...';
      try{
        const res = await fetch('/strategy/pine/preview', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({code})});

        if (!res.ok){ st.textContent = 'Error: '+res.status; return; }
        const js = await res.json();
        st.textContent = `${js.result.name} | Sharpe ${js.result.sharpe.toFixed(2)} | Return ${(js.result.total_return*100).toFixed(1)}%`;
        // overlay trades
        js.result.trades.forEach(t => {
          addMarker(t.ts, t.side==='buy'?'belowBar':'aboveBar', t.side==='buy'?'#22c55e':'#ef4444', t.side==='buy'?'arrowUp':'arrowDown', (t.side==='buy'?'Buy':'Sell')+` @ ${t.price.toFixed(2)}`, `${t.side}${t.ts}`);
        });
        // open drawer with a short explanation
        drawerTitle.textContent = js.result.name;
        drawerBody.innerHTML = `<h5>Performance</h5><div class='kv'><span>Sharpe</span><span>${js.result.sharpe.toFixed(2)}</span></div><div class='kv'><span>Total Return</span><span>${(js.result.total_return*100).toFixed(1)}%</span></div><div class='kv'><span>Max DD</span><span>${(js.result.max_drawdown*100).toFixed(1)}%</span></div>`;
        drawer.classList.add('open');
      }catch(e){ st.textContent = 'Error'; }
    };

    connectWS();

    new ResizeObserver(entries => {
      if (!entries.length) return;
      const { width, height } = entries[0].contentRect;
      chart.applyOptions({ width, height });
    }).observe(container);
  </script>


</body>
</html>



