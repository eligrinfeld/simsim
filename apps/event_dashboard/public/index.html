<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Event-Aware Trading Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system; background: #0b0e11; color: #e6e6e6; }
    header { padding: 12px 16px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #20252b; }
    .badge { padding: 2px 8px; border-radius: 999px; background: #1f2937; font-size: 12px; }
    #chart { height: 560px; }
    .legend { display:flex; gap:12px; font-size: 12px; padding: 8px 16px; color: #a7b0bd;}
    .legend span { display:inline-flex; align-items:center; gap:6px;}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dot.green{background:#22c55e}.dot.red{background:#ef4444}.dot.blue{background:#60a5fa}.dot.yellow{background:#eab308}
    .panel { display:flex; gap:16px; padding: 8px 16px; font-size: 12px; color:#a7b0bd; }
    .panel .kv { background:#0e1318;border:1px solid #20252b;border-radius:10px;padding:6px 10px;}
  </style>
</head>
<body>
  <header>
    <strong>SPY — Event Overlay</strong>
    <span class="badge">lightweight-charts</span>
    <span class="badge">Live demo</span>
  </header>
  <div id="chart"></div>
  <div class="legend">
    <span><i class="dot blue"></i> Bar</span>
    <span><i class="dot green"></i> Breakout / NewsBurst</span>
    <span><i class="dot yellow"></i> MacroShock</span>
    <span><i class="dot red"></i> TradeEntryIntent</span>
  </div>
  <div class="panel" id="status">
    <div class="kv">WS: <b id="wsState">connecting…</b></div>
    <div class="kv">Last event: <b id="lastEvt">—</b></div>
  </div>

  <script>
    const container = document.getElementById('chart');
    const chart = LightweightCharts.createChart(container, {
      layout: { background: { color: '#0b0e11' }, textColor: '#e6e6e6' },
      grid: { vertLines: { color: '#1a1f25' }, horzLines: { color: '#1a1f25' } },
      timeScale: { timeVisible: true, secondsVisible: true, borderColor: '#20252b' },
      rightPriceScale: { borderColor: '#20252b' },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    });
    const candleSeries = chart.addCandlestickSeries({
      upColor: '#22c55e', downColor: '#ef4444', borderDownColor: '#ef4444', borderUpColor: '#22c55e', wickDownColor: '#ef4444', wickUpColor: '#22c55e'
    });

    const markers = [];

    fetch('/candles').then(r => r.json()).then(rows => {
      candleSeries.setData(rows.map(k => ({ time: k.time, open: k.open, high: k.high, low: k.low, close: k.close })));
    });

    function addMarker(time, position, color, shape, text, id) {
      markers.push({ time, position, color, shape, text, id });
      candleSeries.setMarkers(markers);
    }

    const wsState = document.getElementById('wsState');
    const lastEvt = document.getElementById('lastEvt');

    const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws');
    ws.onopen = () => wsState.textContent = 'connected';
    ws.onclose = () => wsState.textContent = 'disconnected';
    ws.onerror = () => wsState.textContent = 'error';

    ws.onmessage = (m) => {
      const evt = JSON.parse(m.data);
      lastEvt.textContent = `${evt.type} @ ${new Date(evt.ts * 1000).toLocaleTimeString()}`;

      if (evt.type === 'Bar') {
        const k = evt.data;
        candleSeries.update({ time: k.time, open: k.open, high: k.high, low: k.low, close: k.close });
      }
      if (evt.type === 'Breakout') {
        addMarker(evt.ts, 'aboveBar', '#22c55e', 'arrowUp', 'Breakout', evt.data?.price);
      }
      if (evt.type === 'NewsBurst') {
        addMarker(evt.ts, 'aboveBar', '#22c55e', 'circle', 'NewsBurst (≥3 pos in 2m)', 'news'+evt.ts);
      }
      if (evt.type === 'MacroShock') {
        addMarker(evt.ts, 'belowBar', '#eab308', 'square', `MacroShock (CPI ${evt.data.surprise.toFixed(2)})`, 'macro'+evt.ts);
      }
      if (evt.type === 'TradeEntryIntent') {
        addMarker(evt.ts, 'belowBar', '#ef4444', 'arrowUp', 'TradeEntryIntent (macro→breakout)', 'entry'+evt.ts);
      }
      if (evt.type === 'NewsItem') { console.log('News:', evt.data.headline, 'sent:', evt.data.sentiment); }
    };

    new ResizeObserver(entries => {
      if (!entries.length) return;
      const { width, height } = entries[0].contentRect;
      chart.applyOptions({ width, height });
    }).observe(container);
  </script>
</body>
</html>

